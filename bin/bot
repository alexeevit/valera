#!/usr/bin/env ruby

require 'pathname'
lib_path ||= File.expand_path("../../lib", Pathname.new(__FILE__).realpath)
$LOAD_PATH.unshift(lib_path) unless $LOAD_PATH.include?(lib_path)
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../../Gemfile", Pathname.new(__FILE__).realpath)
require 'rubygems'
require 'bundler/setup'
Bundler.require(:default)
require 'optparse'
require 'logger'
require 'bot'

options = {}
version = "0.0.1"
daemonize_help = "run daemonized in the background (default: false)"
pidfile_help = "the pid filename"
logfile_help = "the log filename"
include_help = "an additional $LOAD_PATH"
debug_help = "set $DEBUG to true"
warn_help = "enable warnings"

op = OptionParser.new
op.banner = "Valera chatty bot."
op.separator ""
op.separator "Usage: valera [options]"
op.separator ""

op.separator "Process options:"
op.on("-d", "--daemonize", daemonize_help) { options[:daemonize] = true  }
op.on("-p", "--pid PIDFILE", pidfile_help) { |value| options[:pidfile] = value }
op.on("-l", "--log LOGFILE", logfile_help) { |value| options[:logfile] = value }
op.separator ""

op.separator "Ruby options:"
op.on("-I", "--include PATH", include_help) { |value| $LOAD_PATH.unshift(*value.split(":").map{ |v| File.expand_path(v) }) }
op.on("--debug", debug_help) { $DEBUG = true }
op.on("--warn", warn_help) { $-w = true }
op.separator ""

op.separator "Common options:"
op.on("-h", "--help")    { puts op.to_s; exit }
op.on("-v", "--version") { puts version; exit }
op.separator ""

op.parse!(ARGV)

options[:telegram_token] = ENV['TELEGRAM_API_TOKEN']
options[:redis_url] = ENV['REDIS_URL']

Bot.new(options).run!
